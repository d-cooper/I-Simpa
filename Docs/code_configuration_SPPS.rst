Using SPPS within I-Simpa
~~~~~~~~~~~~~~~~~~~~~~~~~~

SPPS is already embedded in I-Simpa. Follow the next instructions to run a calculation with the SPPS code in I-Simpa.

**Double left click** on the TCR calculation code in I-Simpa to display all calculation paramaters:

- `Frequency bands`_ for the selection of the frequency band to be used for the calculation

- `Meshing`_ for the meshing configuration

- `Calculation parameters`_ for the calculation parameters


**Right click** on the selected calculation code to display all possible actions:

- Run calculation

- Job list


.. include:: code_configuration_frequency_bands.rst

.. include:: code_configuration_meshing.rst

Calculation parameters
^^^^^^^^^^^^^^^^^^^^^^^^^^^

- 'Active calculation of atmospheric absorption'
	Enables calculation of atmospheric absorption.

- 'Active calculation of diffusion by fitting objects'
	Enables calculation of calculation of diffusion by fitting objects.

	.. important::

		If fitting zones are enabled, by checking this option, it disables the calculation of all fitting zones. If you uncheck this option, the individual configuration of each fitting zone is preserved.

- 'Active calculation of direct field only'
	Enables calculation of direct field only. There is no calculation of the reverberant field.

	.. tip::

		This can be useful if you want to realize a first calculation, as a reference, of the direct field at receivers. The second calculation (direct and reverberant fields) can thus be calculated and compared to the direct field (first calculation).

- 'Active calculation transmission'
	Enables calculation of transmission through walls.

- 'Calculation method'
	Selects the calculation method.

		+ 'Random'
			Select the Random method.

		+ 'Energetic'
			Select the Energetic method.

- 'Echogram per source'
	Check to calculation an echogram for each sound source, for a given receiver. If uncheck, a global echogram is calculated by summing all source contributions.

- 'Export surface receivers for each frequency band'
	Check to export the surface receiver results, for each frequency band. If uncheck, only the global value is exported.

- 'Limit value of the particle extinction: ratio 10^n'
	For the 'Energetic' mode only. It defines a limit value of the particle energy. If the decrease of the particle energy is less than this value (*i.e.* the particle energy is very low), the particle is removed from the domain. For example, if n=60, it means that all particles whose energy will decreases to 60dB, will be removed.

- 'Number of sound particles per source'
	Defines the number of sound particles that are generated by the source.

	.. warning::

		The computational time depends on the number of particles. If you increase the total number of particles, you drastically increase the computaional time.

- 'Number of sound particles per source (display)'
	Defines the number of particles that are used for the particle animation.

	.. note::

		Most of time, you need to consider only few hundreds or thousands particles for the animation. Incerasing this number, will decrease the memory resources.

- 'Random initialization number'
	Initialize the random number series. If you select a number that is different from '0', the random number series will always be the same. The starting number of the random number series will depend on the number you will consider for this parameter.

	.. warning::

		In a multithread simulation, I-Simpa/SPPS can not control the generation of random numbers. It means that this paremeter will have no effect. Multithread simulation occurs when several frequency bands are considered in the simulation. To avoid multithreading, consider only one frequency band calculation.

- 'Receiver radius (m)'
	Defines the receiver radius (in m).

- 'Simulation length (s)'
	Defines the duration (in s) of the simulation.

- 'Surface receiver export'
	Select the kind of results that is exported.

		+ 'Soundmap: intensity'
			Intensity level (in dB).

		+ 'Soundmap: SPL'
			Sound pressure level (in dB).

- 'Time step (s)'
	Time step (in s) for the calculation.

Computational time optimization
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The computationnal time depends mainly of the **Number of sound particles per source**. Thus, in the SPPS code, each sound particle is followed, at each 'Time step' during its propagation inside the 3D domain, experiencing absorption, reflection, diffusion... and so on, during the 'Simulation length' and/or untill the particles disapears when its energy is to small.

Considering a small number of sound particles may not produced relevant results to proceed an interesting acouctic analazis of the 3D model. Thus, it is necessary to consider a *large* number of sound particles. Assigning the good value for *large* is difficult and depends mainly on the scene size and the absorbent nature of the scene (surface absorption and volume absorption).

Few recommandations to evaluate the computationnal time:

- the number of sound particles defined in SPPS ('Number of sound particles per source' parameter) is defined for **each sound source**. Considering *N* sound particles per source and *M* sound sources will generate *N x M* sound particles in the domain;
- one calculation is done for **each frequency band**: considering *F* frequency bands will be equivalent to a calculation with *F x N* sound particles for one source (or *F x N x M* for *M* sources). Note that, by default, the computation is paralleleized on the processor core, for each frequency band (a frequency band for a given core). So the increase of computional time with the nimber of frequency band is not linear;
- in the **'Energetic' mode**, each sound particle is 'alive' during its propagation untill its energy is below a ratio of the initial energy (see 'â€˜'Limit value of the particle extinction: ratio 10^n' parameter). **Increasing** *n* will keep the sound particles longer in the domain, which increases the computational time;
- in the **'Random' mode**, each physical phenomena (absorption, diffusion) is applied by considering probabilistic approaches. Using this mode, the computational time is drastically decreased, but the quality of the results is aslo decrease. It is suggested to consider the 'Random' mode at the initial step of the study, and then to change to the 'Energetic' mode in order to obtain the final result.
